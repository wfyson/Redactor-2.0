<html>
    <head>

        <!-- CSS -->
        <!-- Bootstrap -->
        <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">

        <!-- Personal -->
        <link rel="stylesheet" type="text/css" href="css/style.css">

        <!-- Javascript -->
        <!-- JQuery -->
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    </head>
    <body>

        <input type="file" id="fileinput" />

        <div id="drop_zone">Drop files here</div>
        <output id="list"></output>

        <div id="upload_progress" class="progress">
            <div class="progress-bar" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100" style="width: 0%;">
                <span class="sr-only">60% Complete</span>
            </div>
        </div>

        <script>
            function handleFileSelect(evt) {
                evt.stopPropagation();
                evt.preventDefault();

                var files = evt.dataTransfer.files; // FileList object.

                // files is a FileList of File objects. List some properties.
                var output = [];
                for (var i = 0, f; f = files[i]; i++) {
                    sendRequest(f, f.name);
                }
            }

            function handleDragOver(evt) {
                evt.stopPropagation();
                evt.preventDefault();
                evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.
            }

            // Setup the dnd listeners.
            var dropZone = document.getElementById('drop_zone');
            dropZone.addEventListener('dragover', handleDragOver, false);
            dropZone.addEventListener('drop', handleFileSelect, false);

            // Setup variables for uploading the file
            BYTES_PER_CHUNK = 1024 * 1024; // 1MB chunk sizes.
            var slices;
            var slices2;

            function sendRequest(blob, fname) {

                var xhr;

                var start = 0;
                var end;
                var index = 0;

                // calculate the number of slices required
                slices = Math.ceil(blob.size / BYTES_PER_CHUNK);
                slices2 = slices;

                while (start < blob.size) {
                    end = start + BYTES_PER_CHUNK;
                    if (end > blob.size) {
                        end = blob.size;
                    }

                    uploadFile(blob, index, start, end, fname);

                    start = end;
                    index++;
                }
            }

            function uploadFile(blob, index, start, end, fname) {
                var xhr;
                var end;
                var fd;
                var chunk;
                var url;

                xhr = new XMLHttpRequest();

                xhr.onreadystatechange = function() {
                    if (xhr.readyState == 4) {
                        if (xhr.responseText) {
                            console.log(xhr.responseText);
                        }

                        slices--;
                        
                        updateProgress(slices, slices2);

                        // if we have finished all slices
                        if (slices == 0) {
                            mergeFile(fname);
                        }
                    }
                };

                //if (blob.webkitSlice) {
                //    chunk = blob.webkitSlice(start, end);
                //} else if (blob.mozSlice) {
                //    chunk = blob.mozSlice(start, end);
                //}

                chunk = blob.slice(start, end);

                fd = new FormData();
                fd.append("file", chunk);
                fd.append("name", fname);
                fd.append("index", index);

                xhr.open("POST", "writer.php", true);
                xhr.send(fd);
            }

            function mergeFile(fname) {
                var xhr;
                var fd;

                xhr = new XMLHttpRequest();

                fd = new FormData();
                fd.append("name", fname);
                fd.append("index", slices2);

                xhr.open("POST", "merge.php", true);
                xhr.send(fd);
            }
            
            function updateProgress(slices, totalSlices){
                
                
                
                var percentage = ((totalSlices - slices) / totalSlices) * 100;
                
                var cssPercentage = percentage + "%";
                
                $('#upload_progress .progress-bar').css('width', cssPercentage);                
            }






        </script>

    </body>
</html>